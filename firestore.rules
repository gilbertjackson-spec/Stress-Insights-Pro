/**
 * @fileoverview Firestore Security Rules for the stress survey system.
 *
 * Core Philosophy:
 * This ruleset is designed for a public survey system with a protected admin area.
 * It allows public, anonymous access for viewing and submitting surveys, while
 * requiring authentication for administrative tasks.
 *
 * Key Security Decisions:
 * - Survey data (templates, deployments, company structure) is PUBLICLY READABLE. This is
 *   necessary for the survey page to function for anonymous users without requiring them
 *   to sign in. Anyone with a link can load the survey questions and demographic options.
 * - Survey responses (respondents and answers) can be CREATED by ANYONE with the link.
 *   This is the core of the public survey functionality.
 * - MODIFICATION and DELETION of submitted data (answers, respondents) is STRICTLY FORBIDDEN
 *   to ensure data integrity. Only reading of aggregate reports is allowed for admins.
 * - WRITING administrative data (companies, survey templates, deployments) requires
 *   a user to be signed-in (anonymously or otherwise) to protect the admin panel.
 * - The default security posture is to deny all access unless explicitly allowed.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Publicly readable to allow survey page to fetch company details.
     * Write access is restricted to signed-in users (admins).
     */
    match /companies/{companyId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Publicly readable for survey demographic dropdowns.
     * Write access is restricted to signed-in users (admins).
     */
    match /companies/{companyId}/units/{unitId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Publicly readable for survey demographic dropdowns.
     * Write access is restricted to signed-in users (admins).
     */
    match /companies/{companyId}/units/{unitId}/sectors/{sectorId} {
      allow read: if true;
      allow write: if isSignedIn();
    }
    
    /**
     * @description Publicly readable for survey demographic dropdowns.
     * Write access is restricted to signed-in users (admins).
     */
    match /companies/{companyId}/units/{unitId}/sectors/{sectorId}/positions/{positionId} {
        allow read: if true;
        allow write: if isSignedIn();
    }

    /**
     * @description Publicly readable so the survey page can load the questions.
     * Write access is restricted to signed-in users (admins).
     */
    match /survey_templates/{templateId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Publicly readable so the survey page can load the questions.
     * Write access is restricted to signed-in users (admins).
     */
    match /survey_templates/{templateId}/domains/{domainId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Publicly readable so the survey page can load the questions.
     * Write access is restricted to signed-in users (admins).
     */
    match /survey_templates/{templateId}/domains/{domainId}/questions/{questionId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Publicly readable to allow survey page to fetch deployment details.
     * Write access is restricted to signed-in users (admins).
     */
    match /survey_deployments/{deploymentId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Allows ANYONE to create a survey response. This makes the survey link public.
     * Reading, updating, and deleting are disallowed to protect submitted data.
     * Admin reading of individual responses is also disabled in favor of aggregate reports.
     */
    match /survey_deployments/{deploymentId}/respondents/{respondentId} {
      allow create: if true;
      allow read: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Allows ANYONE to create answers as part of their public submission.
     * Reading, updating, and deleting are disallowed.
     */
    match /survey_deployments/{deploymentId}/respondents/{respondentId}/answers/{answerId} {
      allow create: if true;
      allow read: if isSignedIn();
      allow update, delete: if false;
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }
}
