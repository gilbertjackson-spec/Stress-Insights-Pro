/**
 * @fileoverview Firestore Security Rules for the stress survey system.
 *
 * Core Philosophy:
 * This ruleset is simplified for a controlled environment. It allows public, anonymous
 * access for survey submissions while maintaining basic signed-in protection for the
 * administrative sections.
 *
 * Key Security Decisions:
 * - Survey responses (respondents and answers) can be CREATED by ANYONE with the link (public access).
 *   This removes the need for respondents to be signed in.
 * - Reading, updating, or deleting survey responses is disallowed to protect data integrity.
 * - All administrative data (companies, deployments, templates) requires a user to be
 *   signed-in (anonymously or otherwise) to read or write. This is a basic safeguard
 *   for the admin panel.
 * - The default security posture is to deny all access unless explicitly allowed.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows any signed-in user to manage company data.
     * This is a simplified rule for initial development.
     */
    match /companies/{companyId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage units within a company.
     * This is a simplified rule for initial development.
     */
    match /companies/{companyId}/units/{unitId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage sectors within a company.
     * This is a simplified rule for initial development.
     */
    match /companies/{companyId}/units/{unitId}/sectors/{sectorId} {
      allow read, write: if isSignedIn();
    }
    
    /**
     * @description Allows any signed-in user to manage positions within a company.
     * This is a simplified rule for initial development.
     */
    match /companies/{companyId}/positions/{positionId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage survey templates.
     * This is a simplified rule for initial development.
     */
    match /survey_templates/{templateId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage domains within survey templates.
     * This is a simplified rule for initial development.
     */
    match /survey_templates/{templateId}/domains/{domainId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage questions within domains.
     * This is a simplified rule for initial development.
     */
    match /survey_templates/{templateId}/domains/{domainId}/questions/{questionId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows signed-in users to read/list and write survey deployments.
     * The `read` permission on this path grants both `get` for single documents
     * and `list` for collection queries. The `write` permission grants `create` and `update`.
     */
    match /survey_deployments/{deploymentId} {
      allow read, write: if isSignedIn();
      // Explicitly deny delete for now to prevent accidental data loss.
      allow delete: if false; 
    }

    /**
     * @description Allows ANYONE to create a survey response. This makes the survey link public.
     * Reading, updating, and deleting are disallowed to protect submitted data.
     */
    match /survey_deployments/{deploymentId}/respondents/{respondentId} {
      allow create: if true;
      allow read, update, delete: if false;
    }

    /**
     * @description Allows ANYONE to create answers as part of their public submission.
     * Reading, updating, and deleting are disallowed.
     */
    match /survey_deployments/{deploymentId}/respondents/{respondentId}/answers/{answerId} {
      allow create: if true;
      allow read, update, delete: if false;
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }
}
