/**
 * @fileoverview Firestore Security Rules for the stress survey system.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control (RBAC) model with denormalization
 * to ensure authorization independence and efficient querying.  SuperAdmins have
 * broad access, while ClientAdmins are restricted to managing data within their
 * own company context. Anonymous access is supported for survey respondents via
 * signed tokens.
 *
 * Data Structure:
 * The data is organized hierarchically:
 * - /companies/{companyId}: Company information.
 * - /companies/{companyId}/units/{unitId}: Units within a company.
 * - /companies/{companyId}/units/{unitId}/sectors/{sectorId}: Sectors within a unit.
 * - /survey_templates/{templateId}: Survey templates (managed by SuperAdmins).
 * - /survey_templates/{templateId}/domains/{domainId}: Domains within a survey template.
 * - /survey_templates/{templateId}/domains/{domainId}/questions/{questionId}: Questions within a domain.
 * - /survey_deployments/{deploymentId}: Deployments of survey templates to companies.
 * - /survey_deployments/{deploymentId}/respondents/{respondentId}: Anonymous survey respondents.
 * - /survey_deployments/{deploymentId}/respondents/{respondentId}/answers/{answerId}: Answers to survey questions.
 *
 * Key Security Decisions:
 * - Access to company, unit, and sector data is restricted to ClientAdmins associated with the company.
 * - Survey templates, domains, and questions are managed exclusively by SuperAdmins.
 * - Anonymous survey respondents are granted access to their own data using unique tokens.
 * - No user listing is allowed.
 * - The default security posture for ambiguous relationships is strict owner-only access.
 *
 * Denormalization for Authorization:
 * The `companyId` is denormalized into the `SurveyDeployment` collection to avoid
 * requiring complex `get()` calls to the `companies` collection during authorization.
 * Likewise, `deploymentId` is denormalized into `SurveyRespondent`, and
 * `respondentId` into `Answer`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows any signed-in user to manage company data.
     * This is a simplified rule for initial development.
     */
    match /companies/{companyId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage units within a company.
     * This is a simplified rule for initial development.
     */
    match /companies/{companyId}/units/{unitId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage sectors within a company.
     * This is a simplified rule for initial development.
     */
    match /companies/{companyId}/units/{unitId}/sectors/{sectorId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage survey templates.
     * This is a simplified rule for initial development.
     */
    match /survey_templates/{templateId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage domains within survey templates.
     * This is a simplified rule for initial development.
     */
    match /survey_templates/{templateId}/domains/{domainId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any signed-in user to manage questions within domains.
     * This is a simplified rule for initial development.
     */
    match /survey_templates/{templateId}/domains/{domainId}/questions/{questionId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows signed-in users to manage survey deployments.
     * This rule permits creating and reading survey deployments, which is necessary
     * for the admin dashboard functionality.
     */
    match /survey_deployments/{deploymentId} {
      allow read, create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if false; // Keep delete restricted for now
    }

    /**
     * @description Allows anonymous survey respondents to manage their own data.
     * This is a simplified rule for initial development.
     */
    match /survey_deployments/{deploymentId}/respondents/{respondentId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows anonymous survey respondents to manage their answers.
     * This is a simplified rule for initial development.
     */
    match /survey_deployments/{deploymentId}/respondents/{respondentId}/answers/{answerId} {
      allow read, write: if isSignedIn();
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }
}
